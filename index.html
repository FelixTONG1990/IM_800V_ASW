<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub加密文件下载系统</title>
    <link rel="stylesheet" href=" https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css ">
    <style>
        /* 样式部分与之前相同（为节省篇幅省略，实际使用时需保留完整样式） */
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面结构与之前相同（为节省篇幅省略） -->
    </div>

    <script>
        // 核心修复代码 ========================================================
        // 1. 添加个人访问令牌（PAT）认证
        const GITHUB_PAT = "YOUR_PERSONAL_ACCESS_TOKEN"; // 替换为你的真实Token

        // 2. 修正API请求函数
        async function getRepoFiles(owner, repo, path = '') {
            // 修正API URL格式（关键！）
            const apiUrl = ` https://api.github.com/repos/$ {owner}/${repo}/contents/${encodeURIComponent(path)}`;
            
            // 添加认证头部（解决权限和速率限制问题）
            const headers = {
                'Authorization': `token ${GITHUB_PAT}`,
                'Accept': 'application/vnd.github.v3+json'
            };

            try {
                const response = await fetch(apiUrl, {
                    headers,
                    mode: 'cors' // 显式声明跨域请求
                });

                // 增强错误处理（显示具体状态码）
                if (!response.ok) {
                    let errorMsg = `请求失败 (HTTP ${response.status}): `;
                    switch(response.status) {
                        case 401: errorMsg += "认证失败，请检查PAT权限"; break;
                        case 403: 
                            errorMsg += "API限制或无权访问";
                            // 检查速率限制头部
                            const remaining = response.headers.get('X-RateLimit-Remaining');
                            if (remaining === "0") {
                                const resetTime = new Date(parseInt(response.headers.get('X-RateLimit-Reset')) * 1000);
                                errorMsg += `，请求次数已用尽，重置时间: ${resetTime.toLocaleTimeString()}`;
                            }
                            break;
                        case 404: errorMsg += "仓库不存在或路径错误"; break;
                        default: errorMsg += await response.text();
                    }
                    throw new Error(errorMsg);
                }

                const data = await response.json();
                // 过滤非文件项（目录/submodule等）
                return data.filter(item => item.type === "file");
            } catch (error) {
                // 网络错误处理
                if (error.message.includes("Failed to fetch")) {
                    throw new Error("网络连接失败，请检查代理设置");
                }
                throw error;
            }
        }

        // 3. 文件下载函数（增加错误处理）
        async function getFileContent(owner, repo, path) {
            const rawUrl = ` https://raw.githubusercontent.com/$ {owner}/${repo}/main/${encodeURIComponent(path)}`;
            const response = await fetch(rawUrl);
            if (!response.ok) {
                throw new Error(`下载失败: ${response.status} ${response.statusText}`);
            }
            return await response.blob(); // 使用blob处理二进制文件
        }

        // 4. 错误诊断面板增强
        function showErrorDetails(error) {
            const errorList = document.getElementById('error-list');
            errorList.innerHTML = '';
            
            const errors = [
                `主错误: ${error.message}`,
                "可能原因:",
                "• PAT未添加或权限不足（需repo权限）",
                "• 仓库路径大小写不匹配（GitHub区分大小写）",
                "• 网络代理阻止了API请求",
                "• 仓库为私有且未授权当前PAT"
            ];
            
            errors.forEach(text => {
                const li = document.createElement('li');
                li.textContent = text;
                errorList.appendChild(li);
            });
            document.getElementById('error-details').style.display = 'block';
        }

        // 5. 安全提示（在页面底部添加）
        const footer = document.querySelector('footer');
        footer.innerHTML += `
            <p style="color:#e74c3c;margin-top:10px">
                <i class="fas fa-exclamation-triangle"></i>
                安全提示：个人访问令牌(PAT)需保管在安全环境，避免泄露
            </p>
        `;

        // 其余函数（renderFileList, initPage等）保持与之前相同
        // ...
    </script>
</body>
</html>
